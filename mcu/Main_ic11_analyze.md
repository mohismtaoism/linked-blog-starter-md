# STM32F4工程分析报告
## 1. 工程概述
该工程是基于STM32F4系列微控制器开发的能量平台控制系统，主要用于LigaSure设备的主机控制。项目采用了分层架构设计，包括硬件驱动层、系统服务层和应用层。

## 2. 系统架构
### 2.1 硬件平台
- 微控制器：STM32F4系列（具体型号为STM32F405RG）
- 外设资源：
  - GPIO：用于LED、按键等控制
  - ADC：用于模拟信号采集
  - DAC：用于模拟信号输出
  - USART：用于通信
  - TIM：用于PWM生成和定时
  - 看门狗：包括IWDG和WWDG
### 2.2 软件架构
项目采用分层设计，主要包括以下几层：

1. 硬件抽象层（HAL） ：
   - FWLIB目录：STM32标准外设库
   - CORE目录：Cortex-M4核心文件
2. 驱动层 ：
   - source/driver/device目录：包含各种硬件驱动
   - HARDWARE目录：包含特定硬件模块的驱动
3.   系统服务层 ：
   - SYSTEM目录：提供系统基础服务，如延时、串口等
4. 应用层 ：  
   - source/app目录：包含应用程序逻辑
## 3. 代码流程分析
### 3.1 系统初始化流程
从main.c文件分析，系统初始化流程如下：

1. 配置中断优先级分组（NVIC_PriorityGroupConfig）
2. 初始化硬件定时器（hwtimer_init）
3. 初始化串口（usart_init）
4. 初始化按键（Kiko_Init）
5. 初始化扬声器（Spkeaker_Init）
6. 初始化LED（Led_Init）
7. 初始化ADC（AD_Init）
8. 初始化DMA（DmaSend_date_init）
9. 初始化应用数据（AppDataInit）
10. 初始化应用定时器（AppTimerInit）
11. 配置PWM输出（bsp_TIM_PWM_OUT）
12. 设置GPIO初始状态
13. 进行双线通信初始化和数据发送
14. 设置系统运行状态为空闲（RUN_IDEL）
### 3.2 主循环流程
主循环中执行以下任务：

1. 处理应用定时器（AppTimerProc）
2. 执行计算任务（CalcTask）
3. 执行Modbus主站通信任务（ModbusTask_Marster），与UI和CPU进行通信
## 4. 模块分析
### 4.1 数据结构模块（appdbs.h）
定义了系统的核心数据结构，包括：

- 基本数据类型定义（u_32, u_16, u_8等）
- 电压切换结构（VOLTAGE_SWITCH）
- 控制参数结构（CONTROL_PARAMETER）
- 输入输出状态结构（KKSTATUS）
- 系统RAM结构（TRAM）：包含系统所有运行时数据
### 4.2 计算模块（appcalc.h/c）
负责系统的核心计算逻辑，包括：

- AD采集状态机（E_AD_FSM_STATE）
- Modbus主站状态机（FSM_STATIC_VALUE）
- 设备运行状态机（E_DEVICE_RUN_FSM_STATE）
- PID控制状态机（E_PID_RUN_FSM_STATE）
- 电压与DA值的映射表
- 电流值校准表
### 4.3 通信模块（appcomm.h, hw_usart.h）
负责系统的通信功能：

- Modbus协议实现
- 串口初始化和数据收发
- 通信数据缓冲区管理
### 4.4 PID控制模块（apppid.h）
实现系统的PID控制算法，用于精确控制输出功率和电压。

### 4.5 硬件驱动模块
- 定时器驱动（hw_timer.h）：提供系统时钟、延时和定时功能
- ADC驱动（hw_ad.h）：提供模拟信号采集功能
- GPIO驱动：提供LED、按键等控制功能
- PWM驱动：提供PWM信号输出功能
## 5. 工作流程
根据代码分析，系统的主要工作流程如下：

1. 系统上电初始化各个模块
2. 进入主循环，周期性执行以下任务：
   - 处理定时器事件
   - 采集AD值并进行计算处理
   - 根据计算结果和控制参数，通过PID算法调整输出
   - 通过Modbus协议与UI和其他设备通信
   - 监控系统状态，处理异常情况
## 6. 关键功能
1. 电压控制 ：通过DA输出控制电压值
2. 电流监测 ：通过AD采集监测电流值
3. 阻抗计算 ：根据电压和电流计算阻抗值
4. 功率控制 ：通过PID算法精确控制输出功率
5. 通信接口 ：提供Modbus协议接口与外部设备通信
6. 状态监控 ：监控系统运行状态，处理异常情况
## 7. 总结
该工程是一个完整的嵌入式控制系统，采用分层架构设计，实现了对能量平台的精确控制。系统通过采集模拟信号，经过计算处理后，通过PID算法控制输出，并通过通信接口与外部设备交互。系统具有良好的可靠性和可维护性，适合用于医疗设备等高可靠性要求的场景。